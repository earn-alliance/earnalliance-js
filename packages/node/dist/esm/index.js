import t from"crypto";function e(t,e,i,s){return new(i||(i=Promise))((function(n,r){function o(t){try{c(s.next(t))}catch(t){r(t)}}function d(t){try{c(s.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,d)}c((s=s.apply(t,e||[])).next())}))}var i,s;"function"==typeof SuppressedError&&SuppressedError,function(t){t.Event="event",t.Identifier="identifier"}(i||(i={})),function(t){t.appleId="appleId",t.discordId="discordId",t.email="email",t.epicGamesId="epicGamesId",t.steamId="steamId",t.twitterId="twitterId",t.walletAddress="walletAddress"}(s||(s={}));class n{constructor(t){this._queue=[],this._gameId=t.gameId,this._transporter=t.transporter,this._batchSize=t.batchSize||100,this._interval=t.interval||3e4}addEvent(t){return e(this,void 0,void 0,(function*(){this._queue.push({type:i.Event,event:t}),yield this.scheduleBatch()}))}addIdentifier(t){return e(this,void 0,void 0,(function*(){this._queue.push({type:i.Identifier,identifier:t}),yield this.scheduleBatch()}))}scheduleBatch(){return e(this,void 0,void 0,(function*(){this._queue.length>=this._batchSize?yield this.process():this._timer||(this._timer=setTimeout((()=>e(this,void 0,void 0,(function*(){yield this.process()}))),this._interval))}))}process(){return e(this,void 0,void 0,(function*(){this._timer&&(clearTimeout(this._timer),this._timer=void 0);const t=this._queue.splice(0,this._batchSize),e=[],s=[];t.forEach((t=>{t.type===i.Event&&e.push(t.event),t.type===i.Identifier&&s.push(t.identifier)}));const n={gameId:this._gameId,events:e,identifiers:s};try{yield this._transporter.send(n)}catch(t){}}))}}class r{constructor(t){this._options=t,this._maxRetryAttempts=t.maxRetryAttempts||5}send(t,i=0){return e(this,void 0,void 0,(function*(){try{const{clientId:e}=this._options,i=Date.now(),s={"x-client-id":e,"x-timestamp":`${i}`,"x-signature":this._sign(t,i)};return yield fetch(this._options.dsn,{method:"POST",headers:s}),!0}catch(e){return i<this._maxRetryAttempts&&this._retry(t,i+1)}}))}_sign(e,i){const{clientId:s,clientSecret:n}=this._options,r=`${s}${i}${JSON.stringify(e)}`;return t.createHmac("sha256",n).update(r).digest("hex")}_retry(t,e){const i=1e3*Math.pow(2,e);return new Promise(((s,n)=>{setTimeout((()=>{this.send(t,e).then(s).catch(n)}),i)}))}}class o{constructor(t){this._options=t,this._transporter=new r(t),this._processor=new n(Object.assign(Object.assign({},t),{transporter:this._transporter}))}track(t,e,i,s){const n=function(t,e,i,s){return{userId:t,timestamp:(new Date).toISOString(),event:e,value:"object"==typeof i?void 0:i,traits:"object"==typeof i?i:s}}(t,e,i,s);this._processor.addEvent(n)}setUserIdentifiers(t,e){const i=function(t,e){const{appleId:i,discordId:s,email:n,epicGamesId:r,steamId:o,twitterId:d,walletAddress:c}=e,a={userId:t};return i&&(a.appleId=i),s&&(a.discordId=s),n&&(a.email=n),r&&(a.epicGamesId=r),o&&(a.steamId=o),d&&(a.twitterId=d),c&&(a.walletAddress=c),a}(t,e);this._processor.addIdentifier(i)}}function d(t={}){void 0===t.clientId&&process.env.ALLIANCE_CLIENT_ID&&(t.clientId=process.env.ALLIANCE_CLIENT_ID),void 0===t.clientSecret&&process.env.ALLIANCE_CLIENT_SECRET&&(t.clientSecret=process.env.ALLIANCE_CLIENT_SECRET),void 0===t.dsn&&process.env.ALLIANCE_DSN&&(t.dsn=process.env.ALLIANCE_DSN||"https://events.earnalliance.com/v2/custom-events"),void 0===t.gameId&&process.env.ALLIANCE_GAME_ID&&(t.gameId=process.env.ALLIANCE_GAME_ID);const{clientId:e,clientSecret:i,dsn:s,gameId:n}=t;if(!(e&&i&&s&&n))throw new Error("Missing required client options");return new o({clientId:e,clientSecret:i,dsn:s,gameId:n})}export{d as default};
