"use strict";var e,t,i=require("crypto");function s(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function d(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,d)}c((s=s.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError,function(e){e.Event="event",e.Identifier="identifier"}(e||(e={})),function(e){e.appleId="appleId",e.discordId="discordId",e.email="email",e.epicGamesId="epicGamesId",e.steamId="steamId",e.twitterId="twitterId",e.walletAddress="walletAddress"}(t||(t={}));class n{constructor(e){this._queue=[],this._gameId=e.gameId,this._transporter=e.transporter,this._batchSize=e.batchSize||100,this._interval=e.interval||3e4}addEvent(t){return s(this,void 0,void 0,(function*(){this._queue.push({type:e.Event,event:t}),yield this.scheduleBatch()}))}addIdentifier(t){return s(this,void 0,void 0,(function*(){this._queue.push({type:e.Identifier,identifier:t}),yield this.scheduleBatch()}))}scheduleBatch(){return s(this,void 0,void 0,(function*(){this._queue.length>=this._batchSize?yield this.process():this._timer||(this._timer=setTimeout((()=>s(this,void 0,void 0,(function*(){yield this.process()}))),this._interval))}))}process(){return s(this,void 0,void 0,(function*(){this._timer&&(clearTimeout(this._timer),this._timer=void 0);const t=this._queue.splice(0,this._batchSize),i=[],s=[];t.forEach((t=>{t.type===e.Event&&i.push(t.event),t.type===e.Identifier&&s.push(t.identifier)}));const n={gameId:this._gameId,events:i,identifiers:s};try{yield this._transporter.send(n)}catch(e){}}))}}class r{constructor(e){this._options=e,this._maxRetryAttempts=e.maxRetryAttempts||5}send(e,t=0){return s(this,void 0,void 0,(function*(){try{const{clientId:t}=this._options,i=Date.now(),s={"x-client-id":t,"x-timestamp":`${i}`,"x-signature":this._sign(e,i)};return yield fetch(this._options.dsn,{method:"POST",headers:s}),!0}catch(i){return t<this._maxRetryAttempts&&this._retry(e,t+1)}}))}_sign(e,t){const{clientId:s,clientSecret:n}=this._options,r=`${s}${t}${JSON.stringify(e)}`;return i.createHmac("sha256",n).update(r).digest("hex")}_retry(e,t){const i=1e3*Math.pow(2,t);return new Promise(((s,n)=>{setTimeout((()=>{this.send(e,t).then(s).catch(n)}),i)}))}}class o{constructor(e){this._options=e,this._transporter=new r(e),this._processor=new n(Object.assign(Object.assign({},e),{transporter:this._transporter}))}track(e,t,i,s){const n=function(e,t,i,s){return{userId:e,timestamp:(new Date).toISOString(),event:t,value:"object"==typeof i?void 0:i,traits:"object"==typeof i?i:s}}(e,t,i,s);this._processor.addEvent(n)}setUserIdentifiers(e,t){const i=function(e,t){const{appleId:i,discordId:s,email:n,epicGamesId:r,steamId:o,twitterId:d,walletAddress:c}=t,a={userId:e};return i&&(a.appleId=i),s&&(a.discordId=s),n&&(a.email=n),r&&(a.epicGamesId=r),o&&(a.steamId=o),d&&(a.twitterId=d),c&&(a.walletAddress=c),a}(e,t);this._processor.addIdentifier(i)}}module.exports=function(e={}){void 0===e.clientId&&process.env.ALLIANCE_CLIENT_ID&&(e.clientId=process.env.ALLIANCE_CLIENT_ID),void 0===e.clientSecret&&process.env.ALLIANCE_CLIENT_SECRET&&(e.clientSecret=process.env.ALLIANCE_CLIENT_SECRET),void 0===e.dsn&&process.env.ALLIANCE_DSN&&(e.dsn=process.env.ALLIANCE_DSN||"https://events.earnalliance.com/v2/custom-events"),void 0===e.gameId&&process.env.ALLIANCE_GAME_ID&&(e.gameId=process.env.ALLIANCE_GAME_ID);const{clientId:t,clientSecret:i,dsn:s,gameId:n}=e;if(!(t&&i&&s&&n))throw new Error("Missing required client options");return new o({clientId:t,clientSecret:i,dsn:s,gameId:n})};
